<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ–‡æ˜AIæµ‹è¯•</title>
    <style>
        :root {
            --primary-color: #4CAF50;
            --background-dark: #1a1a1a;
            --panel-bg: rgba(30, 30, 30, 0.95);
            --text-color: #ffffff;
            --border-radius: 8px;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--background-dark);
            color: var(--text-color);
            line-height: 1.6;
            padding: 20px;
        }

        #testInterface {
            max-width: 1200px;
            margin: 0 auto;
        }

        .test-panel {
            background: var(--panel-bg);
            border-radius: var(--border-radius);
            padding: 20px;
            margin-bottom: 20px;
        }

        #eventInput {
            width: 100%;
            min-height: 100px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: var(--border-radius);
            color: var(--text-color);
            font-size: 16px;
            resize: vertical;
            margin-bottom: 10px;
        }

        #submitEvent {
            width: 100%;
            padding: 12px;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: var(--border-radius);
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        #submitEvent:hover {
            background: #45a049;
        }

        #responsesPanel {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .civilization-response {
            background: rgba(255, 255, 255, 0.05);
            border-radius: var(--border-radius);
            padding: 15px;
            border-left: 4px solid;
        }

        .response-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .thinking {
            padding: 10px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: var(--border-radius);
            margin-bottom: 10px;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { opacity: 0.6; }
            50% { opacity: 1; }
            100% { opacity: 0.6; }
        }

        .response-content {
            font-size: 14px;
        }

        .response-section {
            margin-bottom: 15px;
        }

        .response-section h4 {
            margin-bottom: 8px;
            color: var(--primary-color);
        }

        .action-list, .policy-list {
            list-style: none;
        }

        .action-list li, .policy-list li {
            margin-bottom: 5px;
            padding: 5px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 4px;
        }

        /* æ·»åŠ æ–‡æ˜æŒ‰é’®å®¹å™¨æ ·å¼ */
        #civilizationButtons {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
            padding: 15px;
            background: var(--panel-bg);
            border-radius: var(--border-radius);
        }

        .civ-button {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .civ-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .civ-icon {
            font-size: 1.2em;
        }

        /* æ·»åŠ æ¨¡æ€æ¡†æ ·å¼ */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            z-index: 1000;
        }

        .modal-content {
            position: relative;
            background-color: var(--panel-bg);
            margin: 5% auto;
            padding: 20px;
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            border-radius: var(--border-radius);
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }

        .close-button {
            position: absolute;
            right: 20px;
            top: 20px;
            font-size: 24px;
            cursor: pointer;
            color: var(--text-color);
            transition: all 0.3s ease;
        }

        .close-button:hover {
            color: #FF5252;
            transform: scale(1.1);
        }

        .modal-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            padding-bottom: 10px;
        }

        .modal-tab {
            padding: 8px 16px;
            background: rgba(255, 255, 255, 0.05);
            border: none;
            border-radius: 4px;
            color: var(--text-color);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .modal-tab.active {
            background: var(--primary-color);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .info-section {
            margin-bottom: 20px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: var(--border-radius);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-top: 10px;
        }

        .stat-item {
            padding: 10px;
            background: rgba(255, 255, 255, 0.02);
            border-radius: 4px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .progress-bar {
            width: 100%;
            height: 6px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            margin-top: 5px;
            overflow: hidden;
        }

        .progress {
            height: 100%;
            background: var(--primary-color);
            transition: width 0.3s ease;
        }

        /* æ·»åŠ  AI Agent æç¤ºè¯æŒ‰é’®æ ·å¼ */
        .ai-prompt-button {
            background: #9C27B0;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .ai-prompt-button:hover {
            background: #7B1FA2;
        }

        /* AI Agent æç¤ºè¯æ¨¡æ€æ¡†æ ·å¼ */
        .ai-prompt-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 2000;
        }

        .ai-prompt-content {
            position: relative;
            background: var(--panel-bg);
            margin: 5% auto;
            padding: 20px;
            width: 90%;
            max-width: 1000px;
            max-height: 90vh;
            overflow-y: auto;
            border-radius: var(--border-radius);
        }

        .ai-prompt-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .ai-prompt-text {
            white-space: pre-wrap;
            font-family: monospace;
            background: rgba(0, 0, 0, 0.2);
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 20px;
        }

        .civilization-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
        }

        .civilization-button {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .civilization-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .ai-params-button {
            background: #2196F3;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
        }

        .ai-params-button:hover {
            background: #1976D2;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(33, 150, 243, 0.2);
        }

        .params-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            padding-bottom: 10px;
        }

        .params-tab {
            padding: 8px 16px;
            background: rgba(255, 255, 255, 0.05);
            border: none;
            border-radius: 4px;
            color: var(--text-color);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .params-tab.active {
            background: #2196F3;
        }

        .params-section {
            margin-bottom: 20px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
        }

        .params-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .param-item {
            background: rgba(255, 255, 255, 0.03);
            padding: 12px;
            border-radius: 6px;
        }

        .param-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .param-name {
            font-weight: bold;
            color: #81D4FA;
        }

        .param-value {
            font-family: monospace;
            color: #4CAF50;
        }

        .algorithm-section {
            margin-bottom: 20px;
        }

        .algorithm-code {
            background: rgba(0, 0, 0, 0.3);
            padding: 15px;
            border-radius: 6px;
            font-family: monospace;
            white-space: pre-wrap;
            font-size: 14px;
            line-height: 1.5;
            overflow-x: auto;
        }

        .formula {
            font-family: monospace;
            background: rgba(33, 150, 243, 0.1);
            padding: 8px;
            border-radius: 4px;
            margin: 5px 0;
        }
    </style>
</head>
<body>
    <div id="testInterface">
        <!-- æ·»åŠ  AI Agent æç¤ºè¯æŒ‰é’® -->
        <div class="control-panel">
            <button id="showAIParams" class="ai-params-button">
                <span>ğŸ“Š</span>
                <span>æŸ¥çœ‹AIæ–‡æ˜ç®—æ³•ä¸å‚æ•°</span>
            </button>
        </div>

        <!-- æ·»åŠ æ–‡æ˜æŒ‰é’®å®¹å™¨ -->
        <div id="civilizationButtons">
            <!-- æ–‡æ˜æŒ‰é’®å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
        </div>

        <div class="test-panel">
            <h2>æ–‡æ˜AIå“åº”æµ‹è¯•</h2>
            <textarea id="eventInput" placeholder="è¾“å…¥ä¸€ä¸ªä¸–ç•Œäº‹ä»¶è¿›è¡Œæµ‹è¯•...">ä¸–ç•Œå¤§æˆ˜çˆ†å‘äº†ï¼Œå„ä¸ªæ–‡æ˜å¦‚ä½•åº”å¯¹ï¼Ÿ</textarea>
            <button id="submitEvent">æäº¤äº‹ä»¶</button>
        </div>
        
        <div class="debug-panel">
            <h3>è°ƒè¯•ä¿¡æ¯</h3>
            <pre id="debugInfo" style="background: rgba(0,0,0,0.3); padding: 10px; max-height: 200px; overflow-y: auto;"></pre>
        </div>
        
        <div id="responsesPanel">
            <!-- AIå“åº”å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
        </div>

        <!-- æ·»åŠ æ¨¡æ€æ¡†ç»“æ„ -->
        <div id="civilizationModal" class="modal">
            <div class="modal-content">
                <span class="close-button">&times;</span>
                <h3 id="modalTitle"></h3>
                <div class="modal-tabs">
                    <button class="modal-tab active" data-tab="basic">åŸºæœ¬ä¿¡æ¯</button>
                    <button class="modal-tab" data-tab="social">ç¤¾ä¼šçŠ¶æ€</button>
                    <button class="modal-tab" data-tab="culture">æ–‡åŒ–ç‰¹å¾</button>
                    <button class="modal-tab" data-tab="conflicts">ç¤¾ä¼šçŸ›ç›¾</button>
                </div>
                <div id="modalContent">
                    <div class="tab-content active" data-tab="basic"></div>
                    <div class="tab-content" data-tab="social"></div>
                    <div class="tab-content" data-tab="culture"></div>
                    <div class="tab-content" data-tab="conflicts"></div>
                </div>
            </div>
        </div>

        <!-- æ·»åŠ  AI Agent æç¤ºè¯æ¨¡æ€æ¡† -->
        <div id="aiPromptModal" class="ai-prompt-modal">
            <div class="ai-prompt-content">
                <div class="ai-prompt-header">
                    <h3>AI Agent æç¤ºè¯</h3>
                    <button class="close-button">Ã—</button>
                </div>
                <div class="civilization-buttons">
                    <!-- æ–‡æ˜æŒ‰é’®å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
                </div>
                <div id="promptContent">
                    <!-- æç¤ºè¯å†…å®¹å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                </div>
            </div>
        </div>

        <!-- ä¿®æ”¹æ¨¡æ€æ¡†æ ‡é¢˜å’Œå†…å®¹ç»“æ„ -->
        <div id="aiParamsModal" class="ai-params-modal">
            <div class="ai-params-content">
                <div class="ai-params-header">
                    <h3>AIæ–‡æ˜ç®—æ³•ä¸å‚æ•°</h3>
                    <button class="close-button">Ã—</button>
                </div>
                <div class="civilization-buttons">
                    <!-- æ–‡æ˜æŒ‰é’®å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
                </div>
                <div id="paramsContent">
                    <div class="params-tabs">
                        <button class="params-tab active" data-tab="basic">åŸºç¡€å‚æ•°</button>
                        <button class="params-tab" data-tab="social">ç¤¾ä¼šç³»ç»Ÿ</button>
                        <button class="params-tab" data-tab="personality">æ€§æ ¼ç‰¹å¾</button>
                        <button class="params-tab" data-tab="algorithm">å†³ç­–ç®—æ³•</button>
                    </div>
                    <div class="params-content">
                        <!-- å‚æ•°å†…å®¹å°†åœ¨è¿™é‡Œæ˜¾ç¤º -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // å…¨å±€é…ç½®
        const CONFIG = {
            API_KEY: 'sk-2f992e9a603b4c9d9e6548a5fb6a1761',
            API_ENDPOINT: 'https://api.deepseek.com/v1/chat/completions'
        };
    </script>
    <script src="ai-prompts.js"></script>
    <script src="civilization-ai.js"></script>
    <script src="civilization.js"></script>
    <script src="ai-character.js"></script>
    <script src="ai-service.js"></script>
    <script src="event-handler.js"></script>
    <script src="game.js"></script>
    <script>
        // ç­‰å¾…æ‰€æœ‰è„šæœ¬åŠ è½½å®Œæˆ
        window.addEventListener('load', () => {
            try {
                // åˆ›å»ºæ¸¸æˆå®ä¾‹
                const game = new Game();
                window.game = game; // ä¿å­˜åˆ°å…¨å±€å˜é‡ï¼Œæ–¹ä¾¿è°ƒè¯•

                // è·å–UIå…ƒç´ 
                const eventInput = document.getElementById('eventInput');
                const submitButton = document.getElementById('submitEvent');
                const responsesPanel = document.getElementById('responsesPanel');

                // è°ƒè¯•æ—¥å¿—å‡½æ•°
                function logDebug(message, data = null) {
                    const debugInfo = document.getElementById('debugInfo');
                    const timestamp = new Date().toLocaleTimeString();
                    const logMessage = data ? 
                        `[${timestamp}] ${message}\n${JSON.stringify(data, null, 2)}` :
                        `[${timestamp}] ${message}`;
                    
                    debugInfo.textContent = logMessage + '\n' + debugInfo.textContent;
                }

                // äº‹ä»¶å¤„ç†
                submitButton.addEventListener('click', async () => {
                    const eventText = eventInput.value.trim();
                    if (eventText) {
                        logDebug('æäº¤äº‹ä»¶:', eventText);
                        
                        // æ¸…ç©ºä¹‹å‰çš„å“åº”
                        responsesPanel.innerHTML = '';
                        
                        // ä¸ºæ¯ä¸ªæ–‡æ˜åˆ›å»ºå“åº”é¢æ¿
                        game.civilizations.forEach(civ => {
                            const responseDiv = document.createElement('div');
                            responseDiv.className = 'civilization-response';
                            responseDiv.setAttribute('data-civ', civ.name);
                            responseDiv.style.borderColor = civ.color;
                            responseDiv.innerHTML = `
                                <div class="response-header">
                                    <h3>${civ.name}</h3>
                                </div>
                                <div class="thinking">
                                    <span>ğŸ¤” æ­£åœ¨åˆ†æäº‹ä»¶...</span>
                                </div>
                            `;
                            responsesPanel.appendChild(responseDiv);
                            logDebug(`åˆ›å»º${civ.name}çš„å“åº”é¢æ¿`);
                        });

                        try {
                            // å¤„ç†äº‹ä»¶
                            await game.eventHandler.handleEvent(eventText);
                            logDebug('æ‰€æœ‰æ–‡æ˜å·²å“åº”å®Œæˆ');
                        } catch (error) {
                            logDebug('é”™è¯¯:', error.message);
                            console.error(error);
                        }
                    }
                });

                console.log('Test environment initialized successfully');
                logDebug('æµ‹è¯•ç¯å¢ƒåˆå§‹åŒ–å®Œæˆ');

                // ä¿®æ”¹æŒ‰é’®ç‚¹å‡»äº‹ä»¶å¤„ç†
                const showAIParamsButton = document.getElementById('showAIParams');
                const aiParamsModal = document.getElementById('aiParamsModal');
                const closeButton = aiParamsModal.querySelector('.close-button');
                const civilizationButtons = aiParamsModal.querySelector('.civilization-buttons');
                const paramsContent = document.getElementById('paramsContent');

                showAIParamsButton.addEventListener('click', () => {
                    // ç”Ÿæˆæ–‡æ˜æŒ‰é’®
                    civilizationButtons.innerHTML = game.civilizations.map(civ => `
                        <button class="civilization-button" style="background-color: ${civ.color}" data-civ="${civ.name}">
                            <span>ğŸ›ï¸</span>
                            <span>${civ.name}</span>
                        </button>
                    `).join('');

                    // æ·»åŠ æŒ‰é’®ç‚¹å‡»äº‹ä»¶
                    civilizationButtons.querySelectorAll('.civilization-button').forEach(button => {
                        button.addEventListener('click', () => {
                            const civName = button.getAttribute('data-civ');
                            const civilization = game.civilizations.find(c => c.name === civName);
                            if (civilization) {
                                showCivilizationParams(civilization);
                            }
                        });
                    });

                    aiParamsModal.style.display = 'block';
                });

                function showCivilizationParams(civilization) {
                    const content = paramsContent.querySelector('.params-content');
                    content.innerHTML = `
                        <div class="params-section">
                            <h4>åŸºç¡€å‚æ•°</h4>
                            <div class="params-grid">
                                <div class="param-item">
                                    <div class="param-header">
                                        <span class="param-name">äººå£</span>
                                        <span class="param-value">${civilization.population.toLocaleString()}</span>
                                    </div>
                                    <div class="progress-bar">
                                        <div class="progress" style="width: ${(civilization.population/2000000000)*100}%"></div>
                                    </div>
                                </div>
                                <!-- ... å…¶ä»–åŸºç¡€å‚æ•° ... -->
                            </div>
                        </div>

                        <div class="params-section">
                            <h4>å†³ç­–ç®—æ³•</h4>
                            <div class="algorithm-section">
                                <h5>æ€§æ ¼è®¡ç®—å…¬å¼</h5>
                                <div class="formula">
                                    aggression = base_value + political_factor + cultural_factor + military_factor
                                </div>
                                <div class="algorithm-code">
                                    // æ”»å‡»æ€§è®¡ç®—
                                    calculateAggression(traits) {
                                        let score = 0.5; // åŸºç¡€å€¼
                                        if (traits.governmentType.includes('å†›äº‹')) score += 0.2;
                                        if (traits.governmentType.includes('å’Œå¹³')) score -= 0.2;
                                        // ... å…¶ä»–å› ç´ 
                                        return Math.max(0, Math.min(1, score));
                                    }
                                </div>
                            </div>
                        </div>

                        <div class="params-section">
                            <h4>ç¤¾ä¼šç³»ç»Ÿå‚æ•°</h4>
                            <div class="params-grid">
                                ${Object.entries(civilization.society).map(([key, value]) => `
                                    <div class="param-item">
                                        <div class="param-header">
                                            <span class="param-name">${formatParamName(key)}</span>
                                            <span class="param-value">${Math.round(value * 100)}%</span>
                                        </div>
                                        <div class="progress-bar">
                                            <div class="progress" style="width: ${value * 100}%"></div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                }

                function formatParamName(param) {
                    const nameMap = {
                        stability: "ç¨³å®šæ€§",
                        happiness: "å¹¸ç¦åº¦",
                        education: "æ•™è‚²æ°´å¹³",
                        healthcare: "åŒ»ç–—æ°´å¹³",
                        // ... å…¶ä»–å‚æ•°æ˜ å°„
                    };
                    return nameMap[param] || param;
                }

                // å…³é—­æ¨¡æ€æ¡†
                closeButton.addEventListener('click', () => {
                    aiParamsModal.style.display = 'none';
                });

                // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
                aiParamsModal.addEventListener('click', (event) => {
                    if (event.target === aiParamsModal) {
                        aiParamsModal.style.display = 'none';
                    }
                });

            } catch (error) {
                console.error('Test initialization error:', error);
                document.body.innerHTML += `
                    <div style="color: red; padding: 20px;">
                        åˆå§‹åŒ–é”™è¯¯: ${error.message}
                    </div>
                `;
            }
        });
    </script>
</body>
</html> 